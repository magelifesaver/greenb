/* AAA OGB – Blocks tip UI (v1.3.2) */
(function () {
  const reg=(window.wc&&(window.wc.wcBlocksRegistry||window.wc.blocksRegistry))||window.wcBlocksRegistry||null;
  const {registerPaymentMethod}=reg||{}; const wcSettings=(window.wc&&window.wc.wcSettings)||window.wcSettings;
  const wpEl=window.wp?.element||null; const el=wpEl?.createElement, useState=wpEl?.useState, useEffect=wpEl?.useEffect;
  const select=window.wp?.data?.select, subscribe=window.wp?.data?.subscribe;
  const checkoutAPI=window.wc?.blocksCheckout||null;
  if(!registerPaymentMethod||!wcSettings||!el||!useState){console.warn('[AAA-OGB] Blocks deps missing');return;}

  const IDS=['pay_with_zelle','pay_with_venmo','pay_with_applepay','pay_with_creditcard','pay_with_cashapp','pay_with_cod'];
  const STORE='wc/store'; const TIP_MAP={}; const log=(...a)=>console.log('[AAA-OGB]',...a);

  async function fetchCart(){try{const r=await fetch(((wcSettings?.storeApi?.root)||'/wp-json/wc/store/v1/')+'cart',{credentials:'same-origin'});return await r.json();}catch{return null}}
  function pushCart(c){try{const d=window.wp?.data?.dispatch?.(STORE);if(d?.receiveCart){d.receiveCart(c);return true}}catch{}return false}
  function refreshTotals(){fetchCart().then(c=>{const ok=c&&pushCart(c);log('refresh path=fallback',ok?'receiveCart':'push-missed')});}
  async function syncTip(pm,cents){
    try{
      if(checkoutAPI?.extensionCartUpdate){
        await checkoutAPI.extensionCartUpdate({namespace:'aaa-ogb/tip',data:{pm,tip_cents:cents}});
      }else{
        const url=window.AAA_OGB_AJAX?.url,nonce=window.AAA_OGB_AJAX?.nonce;
        const body=new URLSearchParams({action:'aaa_pm_apply_tip',nonce,tip:(cents/100),pm}).toString();
        await fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},body,credentials:'same-origin'});
        refreshTotals();
      }
      log('sync tip',pm,cents);
    }catch(e){console.error('[AAA-OGB] tip sync error',e);}
  }
  function getSelectedPM(){
    try{
      const c=select?.('wc/store/checkout'); const v=c?.getSelectedPaymentMethod?.()||c?.getSelectedPaymentMethodId?.()||c?.getPaymentMethodId?.();
      if(typeof v==='string') return v; if(v?.paymentMethodId) return v.paymentMethodId; if(v?.id) return v.id;
    }catch{}
    const r=document.querySelector('input[name="radio-control-wc-payment-method-options"]:checked'); return (r&&r.value)||'';
  }
  function hasTipWithLabel(label){
    try{
      const fees=(select?.(STORE)?.getCartTotals()?.fees)||[]; return !!fees.find(f=>f?.name===label && Number(f?.total_amount||0)>0);
    }catch{return false}
  }

  /* Keep tips per method when switching */
  if(!window.__AAA_OGB_SWITCH__){
    window.__AAA_OGB_SWITCH__=true;
    let last=getSelectedPM();
    setInterval(()=>{ const now=getSelectedPM(); if(now && now!==last){ last=now; const cents=Number(TIP_MAP[now]||0); syncTip(now,cents); } }, 400);
  }

  function UI(id,settings){ return function Component(){
    const [,setTick]=useState(0); const bump=()=>setTick(t=>t+1);
    const sym=(wcSettings.currency&&wcSettings.currency.symbol)||'$'; const feeLabel=`Tip (${settings.title})`;
    const STATE=(window.__AAA_OGB_STATE__=window.__AAA_OGB_STATE__||{}); const s=(STATE[id]=STATE[id]||{tip:settings?.tipping?.default||'',applied:false});

    /* Subscribe to cart changes – correct our optimistic UI */
    useEffect(()=>{ const sync=()=>{ const now=hasTipWithLabel(feeLabel); if(now!==s.applied){ s.applied=now; bump(); } };
      sync(); const unsub=subscribe?.(sync); return ()=>unsub&&unsub(); },[]);

    const presets=(settings.tipping?.presets||'').split(',').map(v=>v.trim()).filter(Boolean).map((v,i)=>
      el('button',{key:i,type:'button',className:'button',onClick:()=>{s.tip=parseFloat(v)||0;bump();},style:{marginRight:'6px'}},sym+Number(v).toFixed(0))
    );

    const onApply=async()=>{ const cents=Math.max(0,Math.round((parseFloat(s.tip)||0)*100)); TIP_MAP[id]=cents; s.applied=cents>0; bump(); await syncTip(id,cents); };
    const onRemove=async()=>{ s.tip=''; TIP_MAP[id]=0; s.applied=false; bump(); await syncTip(id,0); };

    const showRemove = !!s.applied || (Number(TIP_MAP[id]||0)>0);

    return el('div',{},
      settings.tipping?.enabled?el('div',{className:'aaa-tip'},
        el('label',{},'Tip (optional)'),
        presets.length?el('div',{style:{margin:'6px 0'}},...presets):null,
        el('div',{style:{display:'flex',gap:'6px',alignItems:'center'}},
          el('input',{type:'number',min:'0',step:'0.01',value:(s.tip??''),onChange:e=>{s.tip=e.target.value;bump();},style:{width:'110px'}}),
          el('button',{type:'button',className:'button button-primary',onClick:onApply},'Apply tip'),
          showRemove?el('button',{type:'button',className:'button',onClick:onRemove},'Remove tip'):null
        )
      ):null,
      settings.description?el('div',{className:'aaa-desc',dangerouslySetInnerHTML:{__html:settings.description}}):null
    );
  };}

  IDS.forEach(id=>{
    const cfg=wcSettings.getSetting(id+'_data',{}); const ok=!!cfg&&!!cfg.title; log('method',id,'hasData=',ok,cfg||{});
    if(!ok) return; const Comp=UI(id,cfg);
    registerPaymentMethod({
      name:id,label:el('span',{},cfg.title),ariaLabel:cfg.title,canMakePayment:()=>true,
      supports:{features:['products']},content:el(Comp),edit:el(Comp),paymentMethodId:id,
      onPaymentSetup:()=>({paymentMethodData:{ tip_amount:String((window.__AAA_OGB_STATE__?.[id]?.tip)||'') }})
    });
    log('registered',id);
  });
})();
